<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>The BLK Group Lab</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#fafafa;
  --card-bg:#fff;
  --border:rgba(0,0,0,0.08);
  --border-hover:rgba(0,0,0,0.12);
  --gold:#B8960C;
  --gold-light:rgba(184,150,12,0.08);
  --gold-dim:rgba(184,150,12,0.4);
  --text-primary:#1a1a1a;
  --text-secondary:#666;
  --text-dim:#aaa;
  --sage:#5B8A5A;
  --sage-light:rgba(91,138,90,0.08);
  --danger:#e54545;
  --danger-light:rgba(229,69,69,0.08);
  --purple:#7B5EA7;
  --purple-light:rgba(123,94,167,0.1);
}
body{font-family:-apple-system,BlinkMacSystemFont,'Inter','SF Pro Display','Helvetica Neue',sans-serif;background:var(--bg);color:var(--text-primary);overflow:hidden;height:100vh;-webkit-font-smoothing:antialiased}
body::before{display:none}
.app{display:flex;height:100vh;position:relative;z-index:1}
.sidebar{width:250px;background:#fff;border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
.sidebar-header{padding:28px 24px;border-bottom:1px solid var(--border);text-align:center}
.sidebar-header h1{font-size:14px;font-weight:700;letter-spacing:5px;color:#111;text-transform:uppercase}
.sidebar-header .sub{font-size:10px;color:var(--text-dim);letter-spacing:3px;margin-top:6px;text-transform:uppercase;font-weight:400}
.nav{flex:1;padding:12px 0;overflow-y:auto}
.nav-item{display:flex;align-items:center;gap:12px;padding:13px 24px;cursor:pointer;transition:all 0.2s;color:var(--text-secondary);font-size:13px;font-weight:500;letter-spacing:0.3px;position:relative;border-left:2px solid transparent}
.nav-item:hover{background:rgba(0,0,0,0.02);color:var(--text-primary)}
.nav-item.active{background:var(--gold-light);color:var(--gold);border-left-color:var(--gold);font-weight:600}
.nav-item .icon{font-size:16px;width:24px;text-align:center}
.nav-item .badge{position:absolute;right:16px;background:var(--danger);color:#fff;font-size:10px;font-weight:700;padding:2px 7px;border-radius:10px;min-width:20px;text-align:center}
.sidebar-footer{padding:16px 20px;border-top:1px solid var(--border);text-align:center}
.sidebar-footer .status{font-size:10px;color:var(--text-dim);letter-spacing:1px}
.sidebar-footer .status .dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--sage);margin-right:6px;animation:pulse-dot 2s infinite}
@keyframes pulse-dot{0%,100%{opacity:1}50%{opacity:0.4}}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.topbar{padding:18px 36px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:#fff}
.topbar h2{font-size:14px;font-weight:700;letter-spacing:3px;color:#111;text-transform:uppercase}
.topbar .date{font-size:11px;color:var(--text-dim);letter-spacing:1px;font-weight:500}
.content{flex:1;overflow:auto;padding:20px 24px}
.page{display:none}
.page.active{display:block}
.card{background:#fff;border:1px solid var(--border);border-radius:14px;margin-bottom:24px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,0.04)}
.card-header{padding:16px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:rgba(0,0,0,0.01)}
.card-header h3{font-size:11px;font-weight:700;letter-spacing:2.5px;color:#111;text-transform:uppercase}
.card-header .month-label{font-size:11px;color:var(--text-secondary);letter-spacing:1px}
.card-body{padding:0;overflow-x:auto}
.lab-table{width:100%;border-collapse:collapse;font-size:12px;table-layout:auto}
.lab-table thead th{font-size:9px;font-weight:600;letter-spacing:1px;color:var(--text-dim);text-transform:uppercase;padding:8px 4px;text-align:left;border-bottom:1px solid var(--border);white-space:nowrap}
.lab-table tbody tr{border-bottom:1px solid rgba(0,0,0,0.04);transition:background 0.2s;cursor:grab}
.lab-table tbody tr:hover{background:rgba(0,0,0,0.015)}
.lab-table tbody td{padding:4px 3px;color:var(--text-secondary);vertical-align:middle}
.lab-table tbody td input,.lab-table tbody td select,.lab-table tbody td textarea{background:#fafafa;border:1px solid var(--border);color:var(--text-primary);padding:6px 8px;border-radius:6px;font-size:12px;font-family:inherit;outline:none;width:100%;min-width:0;transition:all 0.2s}
.lab-table tbody td input:focus,.lab-table tbody td select:focus{border-color:var(--gold);box-shadow:0 0 0 3px var(--gold-light)}
.lab-table tbody td select{cursor:pointer}
.lab-table tbody td input[type="date"]{cursor:pointer;min-width:110px}
.lab-table tbody td .row-num{font-size:11px;color:var(--text-dim);font-weight:600}
.totals-row{display:flex;gap:24px;padding:16px 24px;border-top:1px solid var(--border);background:rgba(0,0,0,0.015)}
.totals-row .total-item{text-align:center}
.totals-row .total-item .val{font-size:20px;font-weight:700;color:#111;letter-spacing:0.5px}
.totals-row .total-item .lbl{font-size:9px;color:var(--text-dim);letter-spacing:1.5px;text-transform:uppercase;margin-top:4px;font-weight:500}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 18px;border:1px solid var(--border);background:#fff;color:var(--text-secondary);border-radius:10px;cursor:pointer;font-size:12px;font-family:inherit;transition:all 0.2s;letter-spacing:0.3px;font-weight:500}
.btn:hover{background:#f5f5f5;color:var(--text-primary);border-color:var(--border-hover)}
.btn-arc{border-color:var(--gold);color:var(--gold)}
.btn-arc:hover{background:var(--gold-light)}
.btn-claim{background:var(--sage-light);border-color:var(--sage);color:var(--sage);font-weight:600;padding:6px 14px;font-size:11px;border-radius:8px}
.btn-claim:hover{background:rgba(91,138,90,0.15)}
.add-row-btn{width:100%;padding:12px;border:1px dashed var(--border);background:transparent;color:var(--text-dim);cursor:pointer;font-size:12px;font-family:inherit;transition:all 0.2s;border-radius:0 0 14px 14px;font-weight:500;letter-spacing:0.5px}
.add-row-btn:hover{background:var(--gold-light);color:var(--gold);border-color:var(--gold-dim)}
.source-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-bottom:24px}
.source-card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:24px;cursor:pointer;transition:all 0.25s;text-align:center;position:relative;box-shadow:0 1px 4px rgba(0,0,0,0.04)}
.source-card:hover{border-color:var(--border-hover);transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.08)}
.source-card .source-icon{font-size:28px;margin-bottom:8px}
.source-card .source-name{font-size:13px;font-weight:600;color:var(--text-primary);margin-bottom:4px}
.source-card .source-count{font-size:11px;color:var(--text-dim)}
.source-card .new-badge{position:absolute;top:10px;right:10px;background:var(--danger);color:#fff;font-size:10px;font-weight:700;padding:3px 8px;border-radius:10px;min-width:22px;text-align:center}
.progress-wrap{position:relative;display:flex;align-items:center;padding:4px 0}
.progress-track-bg{position:absolute;top:50%;left:11px;right:11px;height:2px;background:var(--border);transform:translateY(-1px)}
.progress-fill{position:absolute;top:50%;left:11px;height:2px;background:linear-gradient(90deg,var(--gold-dim),var(--gold));transform:translateY(-1px);transition:width 0.5s ease}
.progress-step{display:flex;flex-direction:column;align-items:center;gap:4px;position:relative;z-index:2;flex:1}
.step-check{width:24px;height:24px;border-radius:50%;border:1.5px solid var(--border);background:#fafafa;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:center;font-size:10px;color:transparent}
.step-check.done{background:var(--gold);border-color:var(--gold);color:#fff}
.step-check:hover{border-color:var(--gold)}
.step-label{font-size:7px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px;text-align:center;max-width:65px;line-height:1.3}
.graph-card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:24px;margin-bottom:24px;box-shadow:0 1px 4px rgba(0,0,0,0.04)}
.graph-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.graph-header h4{font-size:11px;font-weight:700;letter-spacing:2.5px;color:#111;text-transform:uppercase}
.condition-badge{padding:5px 14px;border-radius:20px;font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase}
.condition-badge.power{background:rgba(91,138,90,0.1);color:#3d7a3d;border:1px solid rgba(91,138,90,0.2)}
.condition-badge.affluence{background:rgba(184,150,12,0.08);color:var(--gold);border:1px solid rgba(184,150,12,0.15)}
.condition-badge.normal{background:rgba(60,120,200,0.08);color:#3c78c8;border:1px solid rgba(60,120,200,0.15)}
.condition-badge.emergency{background:rgba(220,130,0,0.08);color:#dc8200;border:1px solid rgba(220,130,0,0.15)}
.condition-badge.danger{background:rgba(220,60,60,0.08);color:#dc3c3c;border:1px solid rgba(220,60,60,0.15)}
.condition-badge.non-existence{background:rgba(128,128,128,0.08);color:#888;border:1px solid rgba(128,128,128,0.15)}
.graph-container{position:relative;height:220px}
.condition-sidebar{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
.cond-item{font-size:10px;color:var(--text-dim);padding:4px 10px;border-radius:6px;background:rgba(0,0,0,0.02);border:1px solid var(--border)}
.cond-formula{font-size:9px;color:var(--text-secondary);margin-top:8px;padding:8px 12px;background:rgba(0,0,0,0.02);border-radius:8px;border:1px solid var(--border);line-height:1.8}
.dragging{opacity:0.4}
.drag-over td{border-top:2px solid var(--gold)!important}
.login-overlay{position:fixed;inset:0;background:#fff;z-index:9999;display:flex;align-items:center;justify-content:center}
.login-box{text-align:center;max-width:380px;width:100%;padding:20px}
.login-box h1{font-size:16px;letter-spacing:6px;color:#111;margin-bottom:6px;font-weight:700;text-transform:uppercase}
.login-box .login-sub{font-size:10px;color:var(--text-dim);letter-spacing:4px;margin-bottom:48px;font-weight:400}
.login-box input{width:100%;padding:14px 20px;background:#fafafa;border:1px solid var(--border);color:var(--text-primary);border-radius:10px;font-size:14px;font-family:inherit;margin-bottom:14px;outline:none;transition:all 0.25s}
.login-box input:focus{border-color:var(--gold);box-shadow:0 0 0 3px var(--gold-light)}
.login-box input::placeholder{color:var(--text-dim)}
.login-box button{width:100%;padding:15px;background:#111;border:none;color:#fff;border-radius:10px;font-size:12px;font-weight:600;letter-spacing:3px;cursor:pointer;transition:all 0.2s;text-transform:uppercase;font-family:inherit}
.login-box button:hover{background:#333}
.login-error{color:var(--danger);font-size:12px;margin-top:8px}
.del-btn{width:22px;height:22px;border-radius:50%;border:1px solid rgba(220,60,60,0.15);background:transparent;color:rgba(220,60,60,0.4);cursor:pointer;font-size:11px;transition:all 0.2s;display:flex;align-items:center;justify-content:center}
.del-btn:hover{background:rgba(220,60,60,0.08);color:var(--danger);border-color:rgba(220,60,60,0.3)}
.ytd-bar{padding:24px;background:rgba(0,0,0,0.015);display:flex;justify-content:center;gap:56px;flex-wrap:wrap;margin-top:16px;border:1px solid var(--border);border-radius:14px}
.ytd-item{text-align:center}
.ytd-item .ytd-val{font-size:26px;font-weight:700;color:#111;letter-spacing:0.5px}
.ytd-item .ytd-lbl{font-size:9px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase;margin-top:6px;font-weight:500}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.1);border-radius:3px}
.perf-grid{display:grid;grid-template-columns:1fr;gap:20px}
.back-btn{background:#fff;border:1px solid var(--border);color:var(--text-secondary);padding:6px 14px;border-radius:6px;cursor:pointer;font-size:12px;margin-bottom:16px;transition:all 0.2s}
.back-btn:hover{color:var(--text-primary);border-color:var(--gold)}
/* ROW COLORS */
.row-gold{background:rgba(184,150,12,0.08)!important}
.row-gold td input,.row-gold td select{background:rgba(184,150,12,0.05)!important}
.row-purple{background:rgba(123,94,167,0.08)!important}
.row-purple td input,.row-purple td select{background:rgba(123,94,167,0.05)!important}
.row-black{background:rgba(0,0,0,0.06)!important}
.row-black td input,.row-black td select{background:rgba(0,0,0,0.04)!important;color:#111!important}
.color-select{width:32px!important;padding:4px!important;border:1px solid var(--border)!important;border-radius:6px!important;background:#fff!important;cursor:pointer!important;font-size:14px!important;text-align:center}
</style>
</head>
<body>
<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <h1>THE BLK GROUP</h1>
    <div class="login-sub">COMMAND CENTER</div>
    <input type="email" id="loginEmail" placeholder="Email" autocomplete="email">
    <input type="password" id="loginPass" placeholder="Password" autocomplete="current-password">
    <button onclick="doLogin()">INITIALIZE</button>
    <div class="login-error" id="loginError"></div>
  </div>
</div>
<div class="app" id="app" style="display:none">
  <div class="sidebar">
    <div class="sidebar-header"><h1>THE LAB</h1><div class="sub">Command Center</div></div>
    <div class="nav">
      <div class="nav-item active" data-page="opens" onclick="showPage('opens')"><span class="icon">üìä</span>Opens</div>
      <div class="nav-item" data-page="leads" onclick="showPage('leads')"><span class="icon">üéØ</span>Active Leads<span class="badge" id="leadsBadge" style="display:none">0</span></div>
      <div class="nav-item" data-page="scorecard" onclick="showPage('scorecard')"><span class="icon">üí∞</span>Monthly Scorecard</div>
      <div class="nav-item" data-page="listings" onclick="showPage('listings')"><span class="icon">üè†</span>Active Listings</div>
      <div class="nav-item" data-page="performance" onclick="showPage('performance')"><span class="icon">üìà</span>Monthly Performance</div>
      <div class="nav-item" data-page="contracts" onclick="showPage('contracts')"><span class="icon">üìù</span>Under Contract</div>
      <div class="nav-item" data-page="jarvis" onclick="showPage('jarvis')"><span class="icon">ü§ñ</span>Jarvis Stats</div>
      <div style="flex:1"></div>
      <div class="nav-item" data-page="nuggets" onclick="showPage('nuggets')" style="border-top:1px solid var(--border);margin-top:8px;padding-top:14px"><span class="icon">üíé</span>Nuggets</div>
    </div>
    <div class="sidebar-footer">
      <div class="status"><span class="dot"></span>JARVIS ONLINE</div>
      <div style="margin-top:8px;text-align:center"><button onclick="doLogout()" style="background:none;border:1px solid var(--border);color:var(--text-dim);padding:6px 16px;border-radius:6px;font-size:11px;cursor:pointer;width:100%;transition:all 0.2s" onmouseover="this.style.borderColor='var(--danger)';this.style.color='var(--danger)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-dim)'">Sign Out</button></div>
    </div>
  </div>
  <div class="main">
    <div class="topbar"><h2 id="pageTitle">OPENS DASHBOARD</h2><div class="date" id="topDate"></div></div>
    <div class="content" id="mainContent">
      <div class="page active" id="page-opens"></div>
      <div class="page" id="page-leads"><div class="source-grid" id="sourceGrid"></div><div id="leadDetail" style="display:none"></div></div>
      <div class="page" id="page-scorecard"></div>
      <div class="page" id="page-listings"></div>
      <div class="page" id="page-performance"><div class="perf-grid" id="perfGrid"></div></div>
      <div class="page" id="page-contracts"></div>
      <div class="page" id="page-jarvis"></div>
      <div class="page" id="page-nuggets"></div>
    </div>
  </div>
</div>
<script>
const SUPA_URL='https://fzlwkbhpsklsgkinwljt.supabase.co';
const SUPA_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ6bHdrYmhwc2tsc2draW53bGp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNTE0MzEsImV4cCI6MjA4NzYyNzQzMX0.lc6A8RCUySU0Hn9MjPcR9rH1c8DjSj_A7MV8JuLvwik';
const sb=supabase.createClient(SUPA_URL,SUPA_KEY);
const AGENTS=['Brandon Bruning','Shelley Lisko','Brad Lisko','Amanda Mitchell','Kevin Cloud'];
const LEAD_SOURCES=['Buyer-Brain','Buyer','Expired Listing Backup','FSBO Backup','Circle Prospect Buyer','Circle Prospect Seller','Off-Market Brain','30 Day Seller'];
const SOURCE_CARDS=[
  {key:'old_expireds',name:'Old Expireds',icon:'üìã'},
  {key:'daily_expireds',name:'Daily Expireds',icon:'üî•'},
  {key:'fsbos',name:'FSBOs',icon:'üè°'},
  {key:'circle_prospecting',name:'Circle Prospecting',icon:'üéØ'},
  {key:'brain_sellers',name:'Brain Sellers',icon:'üß†'},
  {key:'brain_buyers',name:'Brain Buyers',icon:'üèòÔ∏è'},
  {key:'30day_sellers',name:'30 Day Sellers',icon:'üìÖ'},
  {key:'expired_backup',name:'Expired Backup',icon:'üìû'},
  {key:'fsbo_backup',name:'FSBO Backup',icon:'üîë'},
  {key:'off_market',name:'Off-Market Leads',icon:'üîí'}
];
const MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];
const MK=['2026-01','2026-02','2026-03','2026-04','2026-05','2026-06','2026-07','2026-08','2026-09','2026-10','2026-11','2026-12'];
const STEPS=[
  {k:'offer_accepted',l:'Offer Accepted'},{k:'tc_added',l:'TC Added'},{k:'spd_completed',l:'SPD Done'},
  {k:'inspection_scheduled',l:'Inspection'},{k:'irsa_done',l:'IRSA Done'},{k:'irsa_responded',l:'IRSA Responded'},
  {k:'title_setup',l:'Title Setup'},{k:'appraisal_done',l:'Appraisal'},{k:'termite_done',l:'Termite'},
  {k:'closing_scheduled',l:'Closing Set'},{k:'closed',l:'Closed'},{k:'loop_submitted',l:'Loop Done'}
];
let OPENS_TARGET=75,LISTINGS_TARGET=70,MY_COMM_TARGET=67000,GROSS_COMM_TARGET=1600000,VOL_TARGET=65000000;
let currentUser=null,userProfile=null,isAdmin=false;
function $(id){return document.getElementById(id)}
function money(n){return'$'+Number(n||0).toLocaleString()}
function agentOpts(s){return'<option value="">--</option>'+AGENTS.map(a=>`<option${a===s?' selected':''}>${a}</option>`).join('')}
function srcOpts(s){return'<option value="">--</option>'+LEAD_SOURCES.map(a=>`<option${a===s?' selected':''}>${a}</option>`).join('')}

// AUTH
async function doLogin(){
  const e=$('loginEmail').value,p=$('loginPass').value;
  const{data,error}=await sb.auth.signInWithPassword({email:e,password:p});
  if(error){$('loginError').textContent=error.message;return}
  currentUser=data.user;
  await loadUserProfile();
  $('loginOverlay').style.display='none';$('app').style.display='flex';initApp();
}
async function checkAuth(){
  const{data:{session}}=await sb.auth.getSession();
  if(session){currentUser=session.user;await loadUserProfile();$('loginOverlay').style.display='none';$('app').style.display='flex';initApp();}
}
async function loadUserProfile(){
  if(!currentUser)return;
  const{data}=await sb.from('agent_profiles').select('*').eq('user_id',currentUser.id).single();
  if(data){userProfile=data;isAdmin=data.role==='admin';
    if(!isAdmin){OPENS_TARGET=data.opens_goal||10;MY_COMM_TARGET=data.monthly_income_goal||5000;}
  } else {
    // No profile - might be old admin login before migration, or new agent
    userProfile=null;isAdmin=false;
  }
  applyRoleUI();
}
function applyRoleUI(){
  // Hide tabs agents shouldn't see
  const adminOnly=['scorecard','nuggets'];
  adminOnly.forEach(page=>{
    const nav=document.querySelector(`.nav-item[data-page="${page}"]`);
    if(nav) nav.style.display=isAdmin?'':'none';
  });
  // Rename performance tab for agents to "My Performance"
  if(!isAdmin){
    const perfNav=document.querySelector('.nav-item[data-page="performance"]');
    if(perfNav) perfNav.innerHTML='<span class="icon">üìà</span>My Performance';
  }
  // Show onboarding modal if agent with no goals set
  if(!isAdmin && userProfile && !userProfile.opens_goal){
    showOnboarding();
  } else if(!isAdmin && !userProfile){
    showOnboarding();
  }
}
async function showOnboarding(){
  const overlay=document.createElement('div');
  overlay.id='onboardOverlay';
  overlay.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:60000;display:flex;align-items:center;justify-content:center';
  overlay.innerHTML=`<div style="background:var(--card-bg);border-radius:16px;padding:40px;max-width:420px;width:90%;box-shadow:0 8px 40px rgba(0,0,0,0.2)">
    <h2 style="margin-bottom:4px;font-size:20px">Welcome to The Lab</h2>
    <p style="color:var(--text-secondary);font-size:13px;margin-bottom:24px">Let's set your goals so we can track your progress.</p>
    <label style="font-size:12px;font-weight:600;color:var(--text-secondary);display:block;margin-bottom:4px">Monthly Opens Goal</label>
    <input id="obOpens" type="number" placeholder="e.g. 10" style="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:8px;font-size:14px;margin-bottom:16px;background:var(--bg)">
    <label style="font-size:12px;font-weight:600;color:var(--text-secondary);display:block;margin-bottom:4px">Target Monthly Income ($)</label>
    <input id="obMonthly" type="number" placeholder="e.g. 5000" style="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:8px;font-size:14px;margin-bottom:16px;background:var(--bg)">
    <label style="font-size:12px;font-weight:600;color:var(--text-secondary);display:block;margin-bottom:4px">Target Annual Income ($)</label>
    <input id="obAnnual" type="number" placeholder="e.g. 60000" style="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:8px;font-size:14px;margin-bottom:24px;background:var(--bg)">
    <button onclick="saveOnboarding()" style="width:100%;padding:12px;border:none;border-radius:8px;background:var(--gold);color:#fff;font-weight:700;font-size:14px;cursor:pointer">LET'S GO</button>
  </div>`;
  document.body.appendChild(overlay);
}
async function saveOnboarding(){
  const opens=parseInt($('obOpens').value)||10;
  const monthly=parseFloat($('obMonthly').value)||0;
  const annual=parseFloat($('obAnnual').value)||0;
  if(userProfile){
    await sb.from('agent_profiles').update({opens_goal:opens,monthly_income_goal:monthly,annual_income_goal:annual,updated_at:new Date().toISOString()}).eq('user_id',currentUser.id);
  } else {
    await sb.from('agent_profiles').insert({user_id:currentUser.id,email:currentUser.email,full_name:currentUser.user_metadata?.full_name||currentUser.email,role:'agent',opens_goal:opens,monthly_income_goal:monthly,annual_income_goal:annual});
  }
  OPENS_TARGET=opens;MY_COMM_TARGET=monthly;
  userProfile={...userProfile,opens_goal:opens,monthly_income_goal:monthly,annual_income_goal:annual};
  const el=$('onboardOverlay');if(el)el.remove();
  loadOpens();
}
$('loginPass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin()});
async function doLogout(){
  await sb.auth.signOut();
  currentUser=null;userProfile=null;isAdmin=false;
  $('app').style.display='none';$('loginOverlay').style.display='';
  $('loginPass').value='';$('loginError').textContent='';
}

// NAV
const TITLES={opens:'OPENS DASHBOARD',leads:'ACTIVE LEADS',scorecard:'MONTHLY SCORECARD',listings:'ACTIVE LISTINGS',performance:'MONTHLY PERFORMANCE',contracts:'UNDER CONTRACT',jarvis:'JARVIS STATS',nuggets:'NUGGETS'};
function showPage(p){
  document.querySelectorAll('.page').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
  $('page-'+p).classList.add('active');
  document.querySelector(`.nav-item[data-page="${p}"]`).classList.add('active');
  $('pageTitle').textContent=TITLES[p];
  if(p==='opens')loadOpens();if(p==='leads')loadLeads();if(p==='scorecard')loadScorecard();
  if(p==='listings')loadListings();if(p==='performance')loadPerformance();if(p==='contracts')loadContracts();
  if(p==='jarvis')loadJarvis();if(p==='nuggets')loadNugget();
}

// ============ OPENS ============
async function loadOpens(){
  const{data}=await sb.from('lab_opens').select('*').order('sort_order');
  const byMonth={};MK.forEach(m=>byMonth[m]=[]);
  (data||[]).forEach(r=>{if(!byMonth[r.month_year])byMonth[r.month_year]=[];byMonth[r.month_year].push(r)});
  renderOpens(byMonth);
}
function renderOpens(byMonth){
  let html='';
  MK.forEach((mk,i)=>{
    const rows=byMonth[mk]||[];
    html+=`<div class="card" data-month="${mk}">
      <div class="card-header"><h3>${MONTHS[i]} 2026</h3><span class="month-label">${rows.length} OPEN${rows.length!==1?'S':''}</span></div>
      <div class="card-body"><table class="lab-table"><thead><tr>
        <th>#</th><th style="width:36px"></th><th>Agent</th><th>Source</th><th>Name</th><th>Phone</th><th>Email</th><th>Address</th><th>Last Contact</th><th>Next Contact</th><th>Notes</th><th></th>
      </tr></thead><tbody id="opens-${mk}">`;
    rows.forEach((r,ri)=>{
      html+=openRow(r,ri+1,mk);
    });
    html+=`</tbody></table></div>
      <button class="add-row-btn" onclick="addOpen('${mk}')">+ Add Open</button></div>`;
  });
  $('page-opens').innerHTML=html;
  // Setup drag
  MK.forEach(mk=>{
    const tb=document.getElementById('opens-'+mk);
    if(tb) setupDrag(tb,mk);
  });
}
function openRow(r,num,mk){
  const colorClass=r.status==='gold'?'row-gold':r.status==='purple'?'row-purple':r.status==='black'?'row-black':'';
  const colorVal=r.status==='gold'?'üü°':r.status==='purple'?'üü£':r.status==='black'?'‚ö´':'‚ö™';
  return`<tr draggable="true" data-id="${r.id}" data-month="${mk}" class="${colorClass}">
    <td><span class="row-num">${num}</span></td>
    <td><select class="color-select" onchange="updateOpen('${r.id}','status',this.value);loadOpens()"><option value="active"${r.status==='active'||!r.status?' selected':''}>‚ö™</option><option value="gold"${r.status==='gold'?' selected':''}>üü°</option><option value="purple"${r.status==='purple'?' selected':''}>üü£</option><option value="black"${r.status==='black'?' selected':''}>‚ö´</option></select></td>
    <td><select onchange="updateOpen('${r.id}','agent',this.value)">${agentOpts(r.agent)}</select></td>
    <td><select onchange="updateOpen('${r.id}','lead_source',this.value)">${srcOpts(r.lead_source)}</select></td>
    <td><input value="${r.name||''}" onchange="updateOpen('${r.id}','name',this.value)" placeholder="Name" style="min-width:130px"></td>
    <td><input value="${r.phone||''}" onchange="updateOpen('${r.id}','phone',this.value)" placeholder="Phone" style="min-width:115px"></td>
    <td><input value="${r.email||''}" onchange="updateOpen('${r.id}','email',this.value)" placeholder="Email" style="min-width:160px"></td>
    <td><input value="${r.address||''}" onchange="updateOpen('${r.id}','address',this.value)" placeholder="Address" style="min-width:160px"></td>
    <td><input type="date" value="${r.last_contact||''}" onchange="updateOpen('${r.id}','last_contact',this.value)"></td>
    <td><input type="date" value="${r.next_contact||''}" onchange="updateOpen('${r.id}','next_contact',this.value)"></td>
    <td><input value="${r.notes||''}" onchange="updateOpen('${r.id}','notes',this.value)" placeholder="Notes" style="min-width:180px"></td>
    <td><button class="del-btn" onclick="deleteOpen('${r.id}')">x</button></td>
  </tr>`;
}
async function addOpen(mk){
  const rows=document.querySelectorAll(`#opens-${mk} tr`);
  const ins={month_year:mk,sort_order:rows.length,number:rows.length+1};
  if(!isAdmin && currentUser) ins.agent_id=currentUser.id;
  await sb.from('lab_opens').insert(ins);
  loadOpens();
}
async function updateOpen(id,field,val){
  const upd={};upd[field]=val||null;upd.updated_at=new Date().toISOString();
  await sb.from('lab_opens').update(upd).eq('id',id);
}
async function deleteOpen(id){
  if(!confirm('Remove this open?'))return;
  await sb.from('lab_opens').delete().eq('id',id);loadOpens();
}
// DRAG & DROP between months
function setupDrag(tbody,mk){
  tbody.querySelectorAll('tr').forEach(tr=>{
    tr.addEventListener('dragstart',e=>{
      e.dataTransfer.setData('text/plain',tr.dataset.id+'|'+tr.dataset.month);
      tr.classList.add('dragging');
    });
    tr.addEventListener('dragend',()=>tr.classList.remove('dragging'));
  });
  tbody.addEventListener('dragover',e=>{e.preventDefault();});
  tbody.addEventListener('drop',async e=>{
    e.preventDefault();
    const[id,fromMonth]=e.dataTransfer.getData('text/plain').split('|');
    if(fromMonth!==mk){
      await sb.from('lab_opens').update({month_year:mk,updated_at:new Date().toISOString()}).eq('id',id);
      loadOpens();
    }
  });
}

// ============ ACTIVE LEADS ============
let leadsData=[];
async function loadLeads(){
  const{data}=await sb.from('lab_leads').select('*').order('created_at',{ascending:false});
  leadsData=data||[];
  renderLeadSources();
  updateLeadBadge();
}
function renderLeadSources(){
  $('leadDetail').style.display='none';
  $('sourceGrid').style.display='grid';
  let html='';
  SOURCE_CARDS.forEach(sc=>{
    const leads=leadsData.filter(l=>l.lead_source===sc.key);
    const unclaimed=leads.filter(l=>!l.claimed).length;
    html+=`<div class="source-card" onclick="showLeadSource('${sc.key}')">
      ${unclaimed?`<div class="new-badge">${unclaimed}</div>`:''}
      <div class="source-icon">${sc.icon}</div>
      <div class="source-name">${sc.name}</div>
      <div class="source-count">${leads.length} lead${leads.length!==1?'s':''}</div>
    </div>`;
  });
  $('sourceGrid').innerHTML=html;
}
function showLeadSource(key){
  $('sourceGrid').style.display='none';
  $('leadDetail').style.display='block';
  const sc=SOURCE_CARDS.find(s=>s.key===key);
  const leads=leadsData.filter(l=>l.lead_source===key);
  let html=`<button class="back-btn" onclick="renderLeadSources()">‚Üê Back to Sources</button>
    <div class="card"><div class="card-header"><h3>${sc.icon} ${sc.name}</h3><span class="month-label">${leads.length} LEADS</span></div>
    <div class="card-body"><table class="lab-table"><thead><tr>
      <th>Date</th><th>Name</th><th>Phone</th><th>Email</th><th>Address</th><th>Notes</th><th>Status</th><th></th>
    </tr></thead><tbody>`;
  leads.forEach(l=>{
    html+=`<tr style="${!l.claimed?'background:rgba(255,80,80,0.04)':''}">
      <td style="white-space:nowrap">${l.date_added||''}</td>
      <td>${l.name||'--'}</td><td>${l.phone||'--'}</td><td>${l.email||'--'}</td>
      <td>${l.address||'--'}</td><td>${l.notes||'--'}</td>
      <td>${l.claimed?'<span style="color:var(--sage)">Claimed</span>':'<span style="color:var(--danger)">New</span>'}</td>
      <td>${!l.claimed?`<button class="btn-claim" onclick="claimLead('${l.id}','${key}')">Claim ‚Üí Opens</button>`:''}</td>
    </tr>`;
  });
  html+=`</tbody></table></div></div>`;
  $('leadDetail').innerHTML=html;
}
async function claimLead(id,source){
  const lead=leadsData.find(l=>l.id===id);if(!lead)return;
  const now=new Date();const mk=`2026-${String(now.getMonth()+1).padStart(2,'0')}`;
  // Create an open from this lead
  await sb.from('lab_opens').insert({
    month_year:mk,name:lead.name,phone:lead.phone,email:lead.email,
    address:lead.address,lead_source:source,notes:lead.notes
  });
  // Mark lead as claimed
  await sb.from('lab_leads').update({claimed:true,claimed_at:now.toISOString()}).eq('id',id);
  loadLeads();
}
function updateLeadBadge(){
  const unclaimed=leadsData.filter(l=>!l.claimed).length;
  const badge=$('leadsBadge');
  if(unclaimed>0){badge.style.display='inline';badge.textContent=unclaimed;}
  else badge.style.display='none';
}

// ============ MONTHLY SCORECARD ============
async function loadScorecard(){
  const{data}=await sb.from('lab_scorecard').select('*').order('sort_order');
  const byMonth={};MK.forEach(m=>byMonth[m]=[]);
  (data||[]).forEach(r=>{if(!byMonth[r.month_year])byMonth[r.month_year]=[];byMonth[r.month_year].push(r)});
  renderScorecard(byMonth);
}
function renderScorecard(byMonth){
  let html='';let ytdVol=0,ytdGross=0,ytdMy=0;
  MK.forEach((mk,i)=>{
    const rows=byMonth[mk]||[];
    let mVol=0,mGross=0,mMy=0;
    rows.forEach(r=>{mVol+=Number(r.volume||0);mGross+=Number(r.gross_commission||0);mMy+=Number(r.my_commission||0)});
    ytdVol+=mVol;ytdGross+=mGross;ytdMy+=mMy;
    html+=`<div class="card"><div class="card-header"><h3>${MONTHS[i]} 2026</h3><span class="month-label">${rows.length} TRANSACTION${rows.length!==1?'S':''}</span></div>
      <div class="card-body"><table class="lab-table"><thead><tr>
        <th>#</th><th>Transaction Name</th><th>Volume</th><th>Gross Commission</th><th>My Commission</th><th></th>
      </tr></thead><tbody>`;
    rows.forEach((r,ri)=>{
      html+=`<tr>
        <td><span class="row-num">${ri+1}</span></td>
        <td><input value="${r.transaction_name||''}" onchange="updateSC('${r.id}','transaction_name',this.value)" placeholder="Transaction name" style="min-width:200px"></td>
        <td><input type="number" value="${r.volume||''}" onchange="updateSC('${r.id}','volume',this.value)" placeholder="0" style="width:120px"></td>
        <td><input type="number" value="${r.gross_commission||''}" onchange="updateSC('${r.id}','gross_commission',this.value)" placeholder="0" style="width:120px"></td>
        <td><input type="number" value="${r.my_commission||''}" onchange="updateSC('${r.id}','my_commission',this.value)" placeholder="0" style="width:120px"></td>
        <td><button class="del-btn" onclick="deleteSC('${r.id}')">x</button></td>
      </tr>`;
    });
    html+=`</tbody></table></div>
      <div class="totals-row">
        <div class="total-item"><div class="val">${money(mVol)}</div><div class="lbl">Volume</div></div>
        <div class="total-item"><div class="val">${money(mGross)}</div><div class="lbl">Gross Commission</div></div>
        <div class="total-item"><div class="val">${money(mMy)}</div><div class="lbl">My Commission</div></div>
      </div>
      <button class="add-row-btn" onclick="addSC('${mk}')">+ Add Transaction</button></div>`;
  });
  html+=`<div class="ytd-bar">
    <div class="ytd-item"><div class="ytd-val">${money(ytdVol)}</div><div class="ytd-lbl">YTD Volume</div></div>
    <div class="ytd-item"><div class="ytd-val">${money(ytdGross)}</div><div class="ytd-lbl">YTD Gross Commission</div></div>
    <div class="ytd-item"><div class="ytd-val">${money(ytdMy)}</div><div class="ytd-lbl">YTD My Commission</div></div>
  </div>`;
  $('page-scorecard').innerHTML=html;
}
async function addSC(mk){await sb.from('lab_scorecard').insert({month_year:mk});loadScorecard();}
async function updateSC(id,f,v){const u={};u[f]=v||null;u.updated_at=new Date().toISOString();await sb.from('lab_scorecard').update(u).eq('id',id);}
async function deleteSC(id){if(!confirm('Remove?'))return;await sb.from('lab_scorecard').delete().eq('id',id);loadScorecard();}

// ============ ACTIVE LISTINGS ============
async function loadListings(){
  const{data}=await sb.from('lab_listings').select('*').eq('status','active').order('sort_order');
  renderListings(data||[]);
}
function renderListings(rows){
  let totalPrice=0;rows.forEach(r=>totalPrice+=Number(r.price||0));
  let html=`<div class="card"><div class="card-header"><h3>ACTIVE LISTINGS</h3><span class="month-label">${rows.length} LISTING${rows.length!==1?'S':''}</span></div>
    <div class="card-body"><table class="lab-table"><thead><tr>
      <th>#</th><th>Agent</th><th>Listing Type</th><th>Address</th><th>Price</th><th></th>
    </tr></thead><tbody>`;
  rows.forEach((r,i)=>{
    html+=`<tr>
      <td><span class="row-num">${i+1}</span></td>
      <td><select onchange="updateListing('${r.id}','agent',this.value)">${agentOpts(r.agent)}</select></td>
      <td><input value="${r.listing_type||''}" onchange="updateListing('${r.id}','listing_type',this.value)" placeholder="Type"></td>
      <td><input value="${r.address||''}" onchange="updateListing('${r.id}','address',this.value)" placeholder="Address" style="min-width:200px"></td>
      <td><input type="number" value="${r.price||''}" onchange="updateListing('${r.id}','price',this.value)" placeholder="0" style="width:130px"></td>
      <td><button class="del-btn" onclick="deleteListing('${r.id}')">x</button></td>
    </tr>`;
  });
  html+=`</tbody></table></div>
    <div class="totals-row"><div class="total-item"><div class="val">${money(totalPrice)}</div><div class="lbl">Total Listing Volume</div></div></div>
    <button class="add-row-btn" onclick="addListing()">+ Add Listing</button></div>`;
  $('page-listings').innerHTML=html;
}
async function addListing(){const ins={address:'New Listing'};if(!isAdmin&&currentUser)ins.agent_id=currentUser.id;await sb.from('lab_listings').insert(ins);loadListings();}
async function updateListing(id,f,v){const u={};u[f]=v||null;u.updated_at=new Date().toISOString();await sb.from('lab_listings').update(u).eq('id',id);}
async function deleteListing(id){if(!confirm('Remove listing?'))return;await sb.from('lab_listings').delete().eq('id',id);loadListings();}

// ============ UNDER CONTRACT ============
async function loadContracts(){
  const{data}=await sb.from('lab_contracts').select('*').eq('status','active').order('created_at');
  renderContracts(data||[]);
}
function renderContracts(rows){
  let html='';
  rows.forEach(r=>{
    const doneCount=STEPS.filter(s=>r[s.k]).length;
    const pct=STEPS.length>0?(doneCount/STEPS.length)*100:0;
    const fillWidth=doneCount>0?((doneCount-0.5)/STEPS.length)*100:0;
    html+=`<div class="card" style="margin-bottom:16px">
      <div class="card-header">
        <div style="display:flex;align-items:center;gap:12px">
          <input value="${r.transaction_name||''}" onchange="updateContract('${r.id}','transaction_name',this.value)"
            style="background:transparent;border:none;color:#111;font-size:13px;font-weight:600;letter-spacing:0.5px;outline:none;width:250px"
            placeholder="Transaction Name">
          <input type="date" value="${r.contract_date||''}" onchange="contractDateChange('${r.id}',this.value)"
            style="background:#fafafa;border:1px solid var(--border);color:var(--text-secondary);padding:4px 8px;border-radius:6px;font-size:11px">
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-size:11px;font-weight:600;color:var(--text-dim)">${Math.round(pct)}%</span>
          ${pct>=100?`<button class="del-btn" onclick="deleteContract('${r.id}')" title="Remove">x</button>`:''}
        </div>
      </div>
      <div class="card-body" style="padding:16px 20px">
        <div class="progress-wrap">
          <div class="progress-track-bg"></div>
          <div class="progress-fill" style="width:calc(${fillWidth}% - 0px)"></div>`;
    STEPS.forEach(s=>{
      const done=r[s.k];
      html+=`<div class="progress-step">
        <div class="step-check${done?' done':''}" onclick="toggleStep('${r.id}','${s.k}',${!done})">${done?'‚úì':''}</div>
        <div class="step-label">${s.l}</div>
      </div>`;
    });
    html+=`</div>`;
    if(r.spd_due)html+=`<div style="margin-top:8px;font-size:10px;color:var(--text-dim)">SPD Due: ${r.spd_due}</div>`;
    if(r.irsa_due)html+=`<div style="font-size:10px;color:var(--text-dim)">IRSA Due: ${r.irsa_due}</div>`;
    html+=`</div></div>`;
  });
  html+=`<button class="add-row-btn" onclick="addContract()" style="border-radius:12px;margin-top:4px">+ Add Transaction</button>`;
  $('page-contracts').innerHTML=html;
}
async function addContract(){const ins={transaction_name:'New Transaction'};if(!isAdmin&&currentUser)ins.agent_id=currentUser.id;await sb.from('lab_contracts').insert(ins);loadContracts();}
async function updateContract(id,f,v){const u={};u[f]=v||null;u.updated_at=new Date().toISOString();await sb.from('lab_contracts').update(u).eq('id',id);}
async function toggleStep(id,step,val){
  const u={};u[step]=val;u.updated_at=new Date().toISOString();
  await sb.from('lab_contracts').update(u).eq('id',id);loadContracts();
}
async function contractDateChange(id,dateStr){
  const u={contract_date:dateStr,updated_at:new Date().toISOString()};
  if(dateStr){
    const d=new Date(dateStr);
    // SPD due = 3 calendar days after contract
    const spd=new Date(d);spd.setDate(spd.getDate()+3);
    u.spd_due=spd.toISOString().split('T')[0];
    // IRSA due = 10 business days from contract
    const irsa=new Date(d);let biz=0;
    while(biz<10){irsa.setDate(irsa.getDate()+1);if(irsa.getDay()!==0&&irsa.getDay()!==6)biz++;}
    u.irsa_due=irsa.toISOString().split('T')[0];
  }
  await sb.from('lab_contracts').update(u).eq('id',id);loadContracts();
}
async function deleteContract(id){if(!confirm('Remove this transaction?'))return;await sb.from('lab_contracts').delete().eq('id',id);loadContracts();}

// ============ MONTHLY PERFORMANCE ============
let perfCharts={};
function getCondition(val,target){
  const pct=val/target*100;
  if(pct>=93)return{name:'POWER',cls:'power',formula:'Don\'t change anything. Write up what you\'re doing so others can follow it.'};
  if(pct>=73)return{name:'AFFLUENCE',cls:'affluence',formula:'Economize. Don\'t spend recklessly. Every investment must pay for itself. Push, don\'t relax.'};
  if(pct>=60)return{name:'NORMAL',cls:'normal',formula:'Don\'t change anything successful. Improve what isn\'t perfect. Push every piece forward.'};
  if(pct>=47)return{name:'EMERGENCY',cls:'emergency',formula:'Promote. Change nothing. Produce, produce, produce. Get known. Deliver what you promise.'};
  if(pct>=27)return{name:'DANGER',cls:'danger',formula:'Handle the bypassed charge. Reorganize. Deliver a viable product. Stabilize.'};
  return{name:'NON-EXISTENCE',cls:'non-existence',formula:'Find and do a communication line. Make yourself known. Deliver what is needed or wanted.'};
}
async function loadPerformance(){
  // Fetch data - agents only see their own (RLS handles filtering)
  const[opensRes,scoreRes,listRes,contractRes]=await Promise.all([
    sb.from('lab_opens').select('month_year,created_at'),
    isAdmin ? sb.from('lab_scorecard').select('month_year,volume,gross_commission,my_commission') : Promise.resolve({data:[]}),
    sb.from('lab_listings').select('price').eq('status','active'),
    sb.from('lab_contracts').select('transaction_name,closed,created_at')
  ]);
  const opens=opensRes.data||[],scores=scoreRes.data||[],listings=listRes.data||[],contracts=contractRes.data||[];
  // Current month
  const now=new Date();const curMK=`2026-${String(now.getMonth()+1).padStart(2,'0')}`;
  const curMonthOpens=opens.filter(o=>o.month_year===curMK).length;
  const curListings=listings.length;
  const curContracts=contracts.filter(c=>c.closed).length;

  // For agents, use their goals directly; for admin, use the big targets
  const opensTarget=OPENS_TARGET;
  const listingsTarget=isAdmin?LISTINGS_TARGET:Math.max(Math.round(OPENS_TARGET*0.7),5);
  const myCommTarget=MY_COMM_TARGET;
  const grossCommTarget=isAdmin?GROSS_COMM_TARGET:(MY_COMM_TARGET*12*2);
  const volTarget=isAdmin?VOL_TARGET:(MY_COMM_TARGET*12/0.025);

  let curMyComm=0;scores.filter(s=>s.month_year===curMK).forEach(s=>curMyComm+=Number(s.my_commission||0));
  let ytdVol=0,ytdGross=0;scores.forEach(s=>{ytdVol+=Number(s.volume||0);ytdGross+=Number(s.gross_commission||0)});
  // Monthly opens data for chart
  const monthlyOpens=MK.map(mk=>opens.filter(o=>o.month_year===mk).length);
  const monthlyMyComm=MK.map(mk=>{let t=0;scores.filter(s=>s.month_year===mk).forEach(s=>t+=Number(s.my_commission||0));return t});
  const monthlyGross=MK.map(mk=>{let t=0;scores.filter(s=>s.month_year===mk).forEach(s=>t+=Number(s.gross_commission||0));return t});
  const monthlyVol=MK.map(mk=>{let t=0;scores.filter(s=>s.month_year===mk).forEach(s=>t+=Number(s.volume||0));return t});
  // Cumulative for YTD
  let cumGross=[],cumVol=[],g=0,v=0;
  monthlyGross.forEach((mg,i)=>{g+=mg;cumGross.push(g)});
  monthlyVol.forEach((mv,i)=>{v+=mv;cumVol.push(v)});

  const condOpens=getCondition(curMonthOpens,opensTarget);
  const condListings=getCondition(curListings,listingsTarget);
  const condMyComm=getCondition(curMyComm,myCommTarget);
  const condGross=getCondition(ytdGross,grossCommTarget);
  const condVol=getCondition(ytdVol,volTarget);

  let html='';
  // 1. Opens (everyone sees)
  html+=graphCard('perfOpens',isAdmin?'OPENS THIS MONTH':'MY OPENS THIS MONTH',condOpens,`${curMonthOpens} / ${opensTarget}`);
  // 2. Active Listings (everyone sees)
  html+=graphCard('perfListings','ACTIVE LISTINGS',condListings,`${curListings} / ${listingsTarget}`);
  if(isAdmin){
    // 3-5. Commission cards (admin only)
    html+=graphCard('perfMyComm','MY COMMISSION THIS MONTH',condMyComm,`${money(curMyComm)} / ${money(myCommTarget)}`);
    html+=graphCard('perfGross','YTD GROSS COMMISSION',condGross,`${money(ytdGross)} / ${money(grossCommTarget)}`);
    html+=graphCard('perfVol','YTD SALES VOLUME',condVol,`${money(ytdVol)} / ${money(volTarget)}`);
  } else {
    // Agent: Under Contract count card
    const ucTarget=Math.max(Math.round(opensTarget*0.5),3);
    const condUC=getCondition(curContracts,ucTarget);
    html+=graphCard('perfUC','MY UNDER CONTRACT',condUC,`${curContracts} / ${ucTarget}`);
  }

  $('perfGrid').innerHTML=html;

  // Draw charts
  setTimeout(()=>{
    drawChart('perfOpens',MONTHS.map(m=>m.slice(0,3)),monthlyOpens,opensTarget,'Opens');
    drawChart('perfListings',['Current'],[curListings],listingsTarget,'Listings',true);
    if(isAdmin){
      drawChart('perfMyComm',MONTHS.map(m=>m.slice(0,3)),monthlyMyComm,myCommTarget,'$',false,true);
      drawChart('perfGross',MONTHS.map(m=>m.slice(0,3)),cumGross,grossCommTarget,'$',false,true);
      drawChart('perfVol',MONTHS.map(m=>m.slice(0,3)),cumVol,volTarget,'$',false,true);
    }
  },100);
}
function graphCard(canvasId,title,cond,stat){
  return`<div class="graph-card">
    <div class="graph-header">
      <h4>${title}</h4>
      <div style="display:flex;align-items:center;gap:12px">
        <span style="font-size:12px;font-weight:500;color:var(--text-secondary)">${stat}</span>
        <span class="condition-badge ${cond.cls}">${cond.name}</span>
      </div>
    </div>
    <div class="graph-container"><canvas id="${canvasId}"></canvas></div>
    <div class="cond-formula"><strong style="color:var(--text-secondary)">Formula (${cond.name}):</strong> ${cond.formula}</div>
    <div class="condition-sidebar">
      <span class="cond-item" style="border-color:rgba(91,138,90,0.3)">Power 93%+</span>
      <span class="cond-item" style="border-color:rgba(255,215,0,0.2)">Affluence 73%+</span>
      <span class="cond-item" style="border-color:rgba(70,130,255,0.2)">Normal 60%+</span>
      <span class="cond-item" style="border-color:rgba(255,140,0,0.2)">Emergency 47%+</span>
      <span class="cond-item" style="border-color:rgba(255,60,60,0.2)">Danger 27%+</span>
      <span class="cond-item" style="border-color:rgba(128,128,128,0.2)">Non-E &lt;27%</span>
    </div>
  </div>`;
}
function drawChart(id,labels,data,target,unit,isSingle,isMoney){
  const ctx=document.getElementById(id);if(!ctx)return;
  if(perfCharts[id])perfCharts[id].destroy();
  const targetLine=labels.map(()=>isSingle?target:target/12);
  // Projection: extend current trend
  const curMonth=new Date().getMonth();
  const projection=data.map((v,i)=>i<=curMonth?v:null);
  if(curMonth<11&&!isSingle){
    const rate=data.slice(0,curMonth+1).reduce((a,b)=>a+b,0)/(curMonth+1);
    for(let i=curMonth+1;i<12;i++)projection[i]=Math.round(rate);
  }
  perfCharts[id]=new Chart(ctx,{
    type:'line',
    data:{
      labels,
      datasets:[
        {label:unit==='$'?'Actual':'Actual',data,borderColor:'#111',backgroundColor:'rgba(0,0,0,0.03)',fill:true,tension:0.4,pointRadius:4,pointBackgroundColor:'#111',pointBorderColor:'#fff',pointBorderWidth:2},
        {label:'Target',data:isSingle?[target]:labels.map((_,i)=>Math.round(target/12*(i+1))),borderColor:'rgba(184,150,12,0.4)',borderDash:[6,4],pointRadius:0,fill:false},
        ...(isSingle?[]:[{label:'Projection',data:projection,borderColor:'rgba(0,0,0,0.15)',borderDash:[3,3],pointRadius:0,fill:false}])
      ]
    },
    options:{
      responsive:true,maintainAspectRatio:false,
      scales:{
        y:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{color:'rgba(0,0,0,0.35)',font:{size:10,family:'-apple-system,BlinkMacSystemFont,Inter,sans-serif'},callback:v=>isMoney?'$'+v.toLocaleString():v}},
        x:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{color:'rgba(0,0,0,0.35)',font:{size:10,family:'-apple-system,BlinkMacSystemFont,Inter,sans-serif'}}}
      },
      plugins:{legend:{display:true,labels:{color:'rgba(0,0,0,0.4)',font:{size:10,family:'-apple-system,BlinkMacSystemFont,Inter,sans-serif'},boxWidth:12,padding:16}}}
    }
  });
}

// ============ JARVIS STATS ============
const OUTFLOW_SOURCES=[
  {key:'daily_expireds',name:'Daily Expireds',icon:'üî•',desc:'Fresh expired listings, daily outreach'},
  {key:'old_expireds',name:'Old Expireds',icon:'üìã',desc:'Aged expireds from backlog'},
  {key:'fsbos',name:'FSBOs',icon:'üè°',desc:'For Sale By Owner leads'},
  {key:'circle_prospecting',name:'Circle Prospecting',icon:'üéØ',desc:'Neighbors around closed deals'},
  {key:'brain_sellers',name:'Brain Sellers',icon:'üß†',desc:'Off-market database sellers'},
  {key:'brain_buyers',name:'Brain Buyers',icon:'üèòÔ∏è',desc:'Off-market database buyers'},
  {key:'equity_goldmine',name:'Equity Gold Mine',icon:'‚õèÔ∏è',desc:'2014-2020 homeowners with 40-50% equity'},
  {key:'spring_goldmine',name:'Spring Gold Mine',icon:'üå∏',desc:'Spring 2026 multi-channel blitz'},
  {key:'30day_sellers',name:'30 Day Strategy',icon:'üìÖ',desc:'Sellers requesting 30 Day Marketing Strategy'},
  {key:'expired_backup',name:'Expired Backup Plan',icon:'üìû',desc:'ExpiredListingStrategy.com leads'},
  {key:'fsbo_backup',name:'FSBO Backup Plan',icon:'üîë',desc:'FSBOBackupPlan.com leads'},
  {key:'off_market',name:'Off-Market Leads',icon:'üîí',desc:'MakeXHome.com seller/buyer registrations'},
];

async function loadJarvis(){
  // Get all leads and opens for stats
  const[leadsRes,opensRes]=await Promise.all([
    sb.from('lab_leads').select('lead_source,claimed,created_at'),
    sb.from('lab_opens').select('lead_source,month_year,created_at')
  ]);
  const leads=leadsRes.data||[],opens=opensRes.data||[];
  
  // Current month stats
  const now=new Date();const curMK=`2026-${String(now.getMonth()+1).padStart(2,'0')}`;
  const curMonthOpens=opens.filter(o=>o.month_year===curMK).length;
  const daysInMonth=new Date(2026,now.getMonth()+1,0).getDate();
  const dayOfMonth=now.getDate();
  const projectedOpens=dayOfMonth>0?Math.round(curMonthOpens/dayOfMonth*daysInMonth):0;
  const dailyAvg=dayOfMonth>0?(curMonthOpens/dayOfMonth).toFixed(1):'0';
  const neededPerDay=dayOfMonth<daysInMonth?Math.max(0,Math.ceil((OPENS_TARGET-curMonthOpens)/(daysInMonth-dayOfMonth))):0;
  const cond=getCondition(curMonthOpens,OPENS_TARGET);
  
  // Outflow stats by source
  const sourceStats={};
  OUTFLOW_SOURCES.forEach(s=>{
    const srcLeads=leads.filter(l=>l.lead_source===s.key);
    const srcOpens=opens.filter(o=>o.lead_source===s.key);
    sourceStats[s.key]={
      outflows:srcLeads.length,
      conversations:srcLeads.filter(l=>l.claimed).length,
      opens:srcOpens.length
    };
  });

  let html=`
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:28px">
      <div class="card" style="margin:0"><div style="padding:20px;text-align:center">
        <div style="font-size:28px;font-weight:700;color:#111">${curMonthOpens}</div>
        <div style="font-size:9px;color:var(--text-dim);letter-spacing:1.5px;text-transform:uppercase;margin-top:4px">Opens This Month</div>
      </div></div>
      <div class="card" style="margin:0"><div style="padding:20px;text-align:center">
        <div style="font-size:28px;font-weight:700;color:#111">${dailyAvg}</div>
        <div style="font-size:9px;color:var(--text-dim);letter-spacing:1.5px;text-transform:uppercase;margin-top:4px">Daily Average</div>
      </div></div>
      <div class="card" style="margin:0"><div style="padding:20px;text-align:center">
        <div style="font-size:28px;font-weight:700;color:#111">${projectedOpens}</div>
        <div style="font-size:9px;color:var(--text-dim);letter-spacing:1.5px;text-transform:uppercase;margin-top:4px">Projected EOM</div>
      </div></div>
      <div class="card" style="margin:0"><div style="padding:20px;text-align:center">
        <div style="font-size:28px;font-weight:700;color:${neededPerDay>3?'var(--danger)':'var(--sage)'}">${neededPerDay}</div>
        <div style="font-size:9px;color:var(--text-dim);letter-spacing:1.5px;text-transform:uppercase;margin-top:4px">Needed / Day</div>
      </div></div>
    </div>
    
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:28px">
      <div class="card" style="margin:0"><div style="padding:20px;display:flex;align-items:center;justify-content:space-between">
        <div>
          <div style="font-size:9px;color:var(--text-dim);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:6px">Current Condition</div>
          <span class="condition-badge ${cond.cls}" style="font-size:14px;padding:6px 18px">${cond.name}</span>
        </div>
        <div style="font-size:11px;color:var(--text-dim);text-align:right">Target: ${OPENS_TARGET}/mo<br>Day ${dayOfMonth} of ${daysInMonth}</div>
      </div></div>
      <div class="card" style="margin:0"><div style="padding:20px">
        <div style="font-size:9px;color:var(--text-dim);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:6px">Condition Formula</div>
        <div style="font-size:12px;color:var(--text-secondary);line-height:1.7">${cond.formula}</div>
      </div></div>
    </div>
    
    <div class="card">
      <div class="card-header"><h3>Outflow Performance by Source</h3><span style="font-size:10px;color:var(--text-dim);letter-spacing:1px">${MONTHS[now.getMonth()].toUpperCase()} 2026</span></div>
      <div class="card-body"><table class="lab-table"><thead><tr>
        <th></th><th>Source</th><th style="text-align:center">Outflows</th><th style="text-align:center">Conversations</th><th style="text-align:center">Opens</th><th style="text-align:center">Conv %</th><th>Status</th>
      </tr></thead><tbody>`;
  
  let totalOut=0,totalConv=0,totalOpens=0;
  OUTFLOW_SOURCES.forEach(s=>{
    const st=sourceStats[s.key];
    totalOut+=st.outflows;totalConv+=st.conversations;totalOpens+=st.opens;
    const convRate=st.outflows>0?((st.conversations/st.outflows)*100).toFixed(1):'--';
    const status=st.outflows>0?'<span style="color:var(--sage)">Active</span>':'<span style="color:var(--text-dim)">Pending</span>';
    html+=`<tr>
      <td style="font-size:20px;text-align:center;width:40px">${s.icon}</td>
      <td><div style="font-weight:500;color:var(--text-primary)">${s.name}</div><div style="font-size:10px;color:var(--text-dim)">${s.desc}</div></td>
      <td style="text-align:center;font-weight:600;color:var(--text-primary)">${st.outflows}</td>
      <td style="text-align:center;font-weight:600;color:var(--text-primary)">${st.conversations}</td>
      <td style="text-align:center;font-weight:600;color:var(--gold)">${st.opens}</td>
      <td style="text-align:center;color:var(--text-secondary)">${convRate}%</td>
      <td>${status}</td>
    </tr>`;
  });
  html+=`</tbody></table></div>
    <div class="totals-row" style="justify-content:center;gap:48px">
      <div class="total-item"><div class="val">${totalOut}</div><div class="lbl">Total Outflows</div></div>
      <div class="total-item"><div class="val">${totalConv}</div><div class="lbl">Total Conversations</div></div>
      <div class="total-item"><div class="val" style="color:var(--gold)">${totalOpens}</div><div class="lbl">Total Opens</div></div>
    </div>
  </div>`;
  
  $('page-jarvis').innerHTML=html;
}

// ============ NUGGETS ============
const NUGGETS=[
  {q:"The only way you can control people is to lie to them. You can write that down in your book in great big letters. The only way you can control anybody is to lie to them. When you find an individual is lying to you, you know that the individual is trying to control you.",s:"L. Ron Hubbard, Technique 88"},
  {q:"A man is as alive as he can communicate.",s:"L. Ron Hubbard, Dianetics 55!"},
  {q:"Organization is not an end in itself. It is a tool used to accomplish a purpose. It has no other reason for being.",s:"L. Ron Hubbard, OEC Vol. 7"},
  {q:"The product of an org is a well-taught student or a well-audited pc. When you try to make the product money, you fail.",s:"L. Ron Hubbard, OEC Vol. 0"},
  {q:"Look, don't listen.",s:"L. Ron Hubbard, Management Series"},
  {q:"Statistics tell you whether or not the org is being run well or badly.",s:"L. Ron Hubbard, Management Series"},
  {q:"The closest one can come to Static is to approximate Perfect Duplication. The MEST universe is a rough approximation of a perfect duplicate.",s:"L. Ron Hubbard, Axiom 25"},
  {q:"Production is the basis of morale.",s:"L. Ron Hubbard, OEC Vol. 0"},
  {q:"A static has no mass, no motion, no wavelength, no location in space or in time. It has the ability to postulate and to perceive.",s:"L. Ron Hubbard, Axiom 1"},
  {q:"If the stats are down, look for the dev-t. If the stats are up, look for the reason and reinforce it.",s:"L. Ron Hubbard, Data Series"},
  {q:"The way to happiness is a high-speed highway for those who know where the edges are.",s:"L. Ron Hubbard, The Way to Happiness"},
  {q:"An executive who cannot set a good example is not an executive.",s:"L. Ron Hubbard, OEC Vol. 7"},
  {q:"You don't get rich by saving. You get rich by earning.",s:"L. Ron Hubbard, HCO PL Finance Series"},
  {q:"A being is only as valuable as he can serve others.",s:"L. Ron Hubbard, Introduction to Scientology Ethics"},
  {q:"The individual who can freely and with a clear heart do things because they need to be done rates the highest respect.",s:"L. Ron Hubbard, OEC Vol. 0"},
  {q:"Inaction and indecision in the present is because of fear of consequences of the future.",s:"L. Ron Hubbard, OEC Vol. 1"},
  {q:"What is true for you is what you have observed yourself. And when you lose that, you have lost everything.",s:"L. Ron Hubbard, Personal Integrity"},
  {q:"The conditions of existence are not something to be gotten out of, but something to be handled. One handles life, one does not succumb to it.",s:"L. Ron Hubbard, Introduction to Scientology Ethics"},
  {q:"The purpose of ethics is to remove counter-intentions from the environment. And having accomplished that, the purpose becomes to remove other-intentionedness from the environment.",s:"L. Ron Hubbard, Introduction to Scientology Ethics"},
  {q:"Affluence: Don't change anything. Invest in new things. Economize. Don't let your affluence feed extravagance. Pay every bill. Buy what you need. Don't buy to show off.",s:"L. Ron Hubbard, Conditions Formulas"},
  {q:"Power: Don't disconnect. Write up your post so someone else can do it. Do all you can to make things go right for the group.",s:"L. Ron Hubbard, Conditions Formulas"},
  {q:"Emergency: Promote. Change nothing. Produce, produce, produce. Get your product out. Economize. Prepare to deliver.",s:"L. Ron Hubbard, Conditions Formulas"},
  {q:"Danger: Handle the situation and any danger in it. Bypass habits and routines. Handle the personnel connected with it. Reorganize the activity so the situation does not repeat.",s:"L. Ron Hubbard, Conditions Formulas"},
  {q:"Non-Existence: Find a communication line. Make yourself known. Discover what is needed or wanted. Do, produce and/or present it.",s:"L. Ron Hubbard, Conditions Formulas"},
  {q:"Normal Operation: Don't change anything. Ethics are very mild. Stats bettering, don't change anything. If stats worsening, find out why and remedy it.",s:"L. Ron Hubbard, Conditions Formulas"},
  {q:"If you reward down statistics and penalize up statistics you get down statistics.",s:"L. Ron Hubbard, HCO PL Rewards and Penalties"},
  {q:"The biggest single thing that causes the downfall of an executive is his failure to set an example.",s:"L. Ron Hubbard, OEC Vol. 7"},
  {q:"The amount of action that one can take and successfully complete determines one's level of power.",s:"L. Ron Hubbard, Management Series"},
  {q:"The Admin Scale gives you a way to align planning. When all its parts are in agreement, it works. When they conflict, things go wrong.",s:"L. Ron Hubbard, HCO PL Admin Scale"},
  {q:"The only real crime in this universe is to be there and communicate. Everything else is a perversion of that.",s:"L. Ron Hubbard, Philadelphia Doctorate Course"},
  {q:"Purpose is senior to policy.",s:"L. Ron Hubbard, OEC Vol. 0"},
  {q:"You cannot hold a command post and be liked. You can hold a command post and be respected, but trying to be liked will end your command post.",s:"L. Ron Hubbard, OEC Vol. 7"},
  {q:"The moment you have a plan, you have something you can inspect. The moment you can inspect, you can find out what is going right and wrong. And correct.",s:"L. Ron Hubbard, Management Series"},
  {q:"A real genius uses 10% inspiration and 90% sweat. The 10% may be sheer genius, but without the 90% sweat the genius goes unproven.",s:"L. Ron Hubbard, OEC Vol. 0"},
  {q:"It is a wise man who, confronted with conflicting data, knows which data is senior.",s:"L. Ron Hubbard, Data Series"},
  {q:"When you can name something and define it, you have some control of it. When you can't, it has some control over you.",s:"L. Ron Hubbard, Data Series"},
  {q:"The way to make money is to make other people make money.",s:"L. Ron Hubbard, HCO PL Finance Series"},
  {q:"A situation always has at least two sides. Someone out there trying to help you, not just hold you back. Look for the third party.",s:"L. Ron Hubbard, Third Party Law"},
  {q:"The tech of handling people is the tech of ARC. You raise ARC, you raise understanding.",s:"L. Ron Hubbard, Science of Survival"},
  {q:"There are only two tests for a Valuable Final Product: first, that it is exchangeable and second, that it is valuable.",s:"L. Ron Hubbard, HCO PL VFP"},
  {q:"You don't get GI by sitting there hoping someone will walk in and hand you money. You get it by outflowing comm, product, and service.",s:"L. Ron Hubbard, Finance Series"},
  {q:"Obnosis is the observation of the obvious. So many people miss what's right in front of them because they are looking for something else.",s:"L. Ron Hubbard, Study Tapes"},
  {q:"Never use threats. If you say you are going to do something, do it.",s:"L. Ron Hubbard, OEC Vol. 7"},
  {q:"Planning without action is a daydream. Action without planning is a nightmare.",s:"L. Ron Hubbard, Management Series"},
  {q:"The most valuable asset of any organization is the willingness and ability of its people to produce.",s:"L. Ron Hubbard, OEC Vol. 0"},
];

function loadNugget(){
  const n=NUGGETS[Math.floor(Math.random()*NUGGETS.length)];
  $('page-nuggets').innerHTML=`
    <div style="display:flex;align-items:center;justify-content:center;min-height:60vh">
      <div style="max-width:640px;text-align:center;padding:40px">
        <div style="font-size:48px;margin-bottom:24px;opacity:0.15">üíé</div>
        <div style="font-size:20px;font-weight:400;color:#111;line-height:1.8;letter-spacing:0.3px;font-style:italic">"${n.q}"</div>
        <div style="margin-top:24px;font-size:12px;color:var(--gold);letter-spacing:2px;font-weight:600;text-transform:uppercase">- ${n.s}</div>
        <button onclick="loadNugget()" style="margin-top:40px;padding:10px 28px;background:#fff;border:1px solid var(--border);border-radius:8px;color:var(--text-secondary);cursor:pointer;font-size:12px;font-family:inherit;letter-spacing:1px;transition:all 0.2s" onmouseover="this.style.borderColor='var(--gold)';this.style.color='var(--gold)'" onmouseout="this.style.borderColor='';this.style.color=''">ANOTHER</button>
      </div>
    </div>`;
}

// ============ INIT ============
function initApp(){
  updateDate();setInterval(updateDate,60000);
  loadOpens();
  // Check for unclaimed leads
  sb.from('lab_leads').select('id',{count:'exact'}).eq('claimed',false).then(({count})=>{
    if(count>0){$('leadsBadge').style.display='inline';$('leadsBadge').textContent=count;}
  });
}
checkAuth();
</script>

<!-- JARVIS CHAT WIDGET -->
<style>
#jarvisChatBtn{position:fixed;bottom:24px;right:24px;width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,var(--gold) 0%,#8B7209 100%);color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:50000;box-shadow:0 4px 20px rgba(184,150,12,0.4);transition:all 0.3s ease;border:none}
#jarvisChatBtn:hover{transform:scale(1.08);box-shadow:0 6px 30px rgba(184,150,12,0.6)}
#jarvisChatBtn.hidden{opacity:0;pointer-events:none;transform:scale(0.5)}
.jcb-glow{position:absolute;width:100%;height:100%;border-radius:50%;background:rgba(184,150,12,0.3);animation:jc-pulse 2.5s ease-in-out infinite;pointer-events:none}
@keyframes jc-pulse{0%,100%{transform:scale(1);opacity:0.4}50%{transform:scale(1.4);opacity:0}}
.jc-panel{position:fixed;bottom:24px;right:24px;width:400px;height:600px;max-height:calc(100vh - 48px);background:var(--card-bg);border:1px solid var(--border);border-radius:16px;z-index:50001;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 8px 40px rgba(0,0,0,0.15),0 0 60px rgba(184,150,12,0.05);opacity:0;pointer-events:none;transform:translateY(20px) scale(0.95);transition:all 0.25s ease}
.jc-panel.open{opacity:1;pointer-events:all;transform:translateY(0) scale(1)}
.jc-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--bg)}
.jc-hleft{display:flex;align-items:center;gap:10px}
.jc-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--gold),#8B7209);display:flex;align-items:center;justify-content:center;position:relative;font-weight:800;font-size:16px;color:#fff}
.jc-avatar::before{content:'';position:absolute;bottom:0;right:0;width:10px;height:10px;border-radius:50%;background:var(--sage);border:2px solid var(--bg)}
.jc-hname{font-size:14px;font-weight:700;color:var(--text-primary)}
.jc-hsub{font-size:11px;color:var(--text-dim)}
.jc-hactions{display:flex;gap:4px}
.jc-hactions button{background:none;border:none;color:var(--text-dim);cursor:pointer;padding:6px;border-radius:6px;transition:all 0.2s;display:flex;align-items:center}
.jc-hactions button:hover{background:var(--bg);color:var(--text-primary)}
.jc-msgs{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px}
.jc-msg{display:flex;gap:8px;max-width:90%}
.jc-msg-ai{align-self:flex-start}
.jc-msg-user{align-self:flex-end;flex-direction:row-reverse}
.jc-bubble{padding:10px 14px;border-radius:12px;font-size:13px;line-height:1.5;word-wrap:break-word;white-space:pre-wrap}
.jc-msg-ai .jc-bubble{background:var(--bg);color:var(--text-primary);border-bottom-left-radius:4px}
.jc-msg-user .jc-bubble{background:var(--gold);color:#fff;border-bottom-right-radius:4px}
.jc-msg-typing{align-self:flex-start}
.jc-msg-typing .jc-bubble{background:var(--bg);color:var(--text-dim);display:flex;gap:4px;padding:12px 18px}
.jc-tdot{width:6px;height:6px;border-radius:50%;background:var(--text-dim);animation:jc-typ 1.4s ease-in-out infinite}
.jc-tdot:nth-child(2){animation-delay:0.2s}
.jc-tdot:nth-child(3){animation-delay:0.4s}
@keyframes jc-typ{0%,60%,100%{transform:translateY(0);opacity:0.4}30%{transform:translateY(-4px);opacity:1}}
.jc-input{padding:12px;border-top:1px solid var(--border);display:flex;gap:8px;align-items:flex-end;background:var(--card-bg)}
.jc-input textarea{flex:1;background:var(--bg);border:1px solid var(--border);color:var(--text-primary);padding:10px 14px;border-radius:10px;font-size:13px;font-family:inherit;resize:none;outline:none;max-height:120px;line-height:1.4;transition:border-color 0.2s}
.jc-input textarea:focus{border-color:var(--gold)}
.jc-input textarea::placeholder{color:var(--text-dim)}
#jcSendBtn{width:38px;height:38px;border-radius:10px;border:none;background:var(--gold);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s;flex-shrink:0}
#jcSendBtn:hover{background:#a68a0b}
#jcSendBtn:disabled{opacity:0.3;cursor:not-allowed}
</style>

<div id="jarvisChatBtn" onclick="jcToggle()" title="Talk to Jarvis">
  <div class="jcb-glow"></div>
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
</div>
<div id="jcPanel" class="jc-panel">
  <div class="jc-header">
    <div class="jc-hleft">
      <div class="jc-avatar">J</div>
      <div><div class="jc-hname">Jarvis</div><div class="jc-hsub">BLK Group AI</div></div>
    </div>
    <div class="jc-hactions">
      <button onclick="jcClear()" title="New conversation"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
      <button onclick="jcToggle()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
  </div>
  <div class="jc-msgs" id="jcMsgs"><div class="jc-msg jc-msg-ai"><div class="jc-bubble">Hey Brandon. What do you need?</div></div></div>
  <div class="jc-input">
    <textarea id="jcInput" placeholder="Message Jarvis..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();jcSend()}" oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,120)+'px'"></textarea>
    <button id="jcSendBtn" onclick="jcSend()"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
  </div>
</div>

<script>
let jcOpen=false,jcMsgs=[],jcBusy=false,jcSid=null,jcSub=null;
function jcEmail(){return currentUser&&currentUser.email?currentUser.email:'unknown'}
function jcGetSid(){if(jcSid)return jcSid;const k='jc_sid_'+jcEmail();let s=localStorage.getItem(k);if(!s){s='lab:'+jcEmail()+':'+Date.now();localStorage.setItem(k,s)}jcSid=s;return s}
function jcToggle(){jcOpen=!jcOpen;$('jcPanel').classList.toggle('open',jcOpen);$('jarvisChatBtn').classList.toggle('hidden',jcOpen);if(jcOpen){setTimeout(()=>$('jcInput').focus(),300);jcScroll();jcSubscribe();jcLoadHistory()}}
function jcClear(){jcMsgs=[];jcSid=null;localStorage.removeItem('jc_sid_'+jcEmail());$('jcMsgs').innerHTML='<div class="jc-msg jc-msg-ai"><div class="jc-bubble">Fresh start. What do you need?</div></div>'}
async function jcLoadHistory(){const sid=jcGetSid();const{data}=await sb.from('jarvis_chat').select('*').eq('session_id',sid).order('created_at',{ascending:true}).limit(50);if(!data||!data.length)return;$('jcMsgs').innerHTML='';jcMsgs=[];for(const m of data){jcMsgs.push({role:m.role,content:m.content});jcAddMsg(m.role,m.content)}jcScroll()}
function jcSubscribe(){if(jcSub)return;const sid=jcGetSid();jcSub=sb.channel('jc-'+sid).on('postgres_changes',{event:'INSERT',schema:'public',table:'jarvis_chat',filter:'session_id=eq.'+sid},(p)=>{const m=p.new;if(m.role==='assistant'){const t=$('jcTyping');if(t)t.remove();jcMsgs.push({role:'assistant',content:m.content});jcAddMsg('assistant',m.content);jcBusy=false;$('jcSendBtn').disabled=false;$('jcInput').focus()}}).subscribe()}
function jcAddMsg(role,content){const c=$('jcMsgs'),d=document.createElement('div');d.className='jc-msg '+(role==='user'?'jc-msg-user':'jc-msg-ai');const b=document.createElement('div');b.className='jc-bubble';b.textContent=content;d.appendChild(b);c.appendChild(d);jcScroll();return b}
function jcScroll(){const c=$('jcMsgs');requestAnimationFrame(()=>{c.scrollTop=c.scrollHeight})}
async function jcSend(){const inp=$('jcInput'),txt=inp.value.trim();if(!txt||jcBusy)return;inp.value='';inp.style.height='auto';jcBusy=true;$('jcSendBtn').disabled=true;jcMsgs.push({role:'user',content:txt});jcAddMsg('user',txt);const c=$('jcMsgs'),d=document.createElement('div');d.className='jc-msg jc-msg-typing';d.id='jcTyping';d.innerHTML='<div class="jc-bubble"><div class="jc-tdot"></div><div class="jc-tdot"></div><div class="jc-tdot"></div></div>';c.appendChild(d);jcScroll();const{error}=await sb.from('jarvis_chat').insert({session_id:jcGetSid(),user_email:jcEmail(),role:'user',content:txt});if(error){const t=$('jcTyping');if(t)t.remove();jcAddMsg('assistant','Failed to send. Try again.');jcBusy=false;$('jcSendBtn').disabled=false}}
</script>
</body>
</html>